#include <stdint.h>
#include <stdio.h>
#include <assert.h>
#include <string.h>
#include "tlv.h"

#define MAX_TXN_REF_LEN (10)
typedef struct
{
	char TxnRef[MAX_TXN_REF_LEN+1]; // Zero terminated string
	int32_t amount;
	uint8_t txnType;
	uint16_t currencyCode;
} TxnInfo_t;

void indent (int level) {
	while (level--) printf("  ");
}

char * tagclass (uint8_t const * tag) {
	switch (*tag >> 6) {
		case 0x00: return "Universal";
		case 0x01: return "Application";
		case 0x02: return "Context specific";
		case 0x03: return "Private";
	}
	return "BAD";
}

uint16_t tagNumber(uint8_t const * const tag) {
	if ((*tag & 0x1f) == 0x1f) {
		uint16_t val = tag[1] & 0x7f;
		if (tag[1] & (1 << 7)) {
			val <<= 7;
			val |= tag[2] & 0x7f;
		}
		return val;
	}
	return *tag & 0x1f;
}

void printtag (const uint8_t* const tag, int level) {
	printf("\n");
	indent(level);
	printf("class %s\n", tagclass(tag));
	indent(level);
	printf(CONSTRUCTED(tag) ? "constructed\n" : "primative\n");
	indent(level);
	printf("tag number %d\n", tagNumber(tag));
}

#pragma GCC diagnostic push
#pragma GCC diagnostic ignored "-Wunused-parameter"
BOOL printTlvInfo(Tlv_t* tlv, void * _ctx, int level) {
	printtag(tlv->tag, level);
	indent(level);
	printf("size %zu\n", vallength(tlv->len));
	return false;
}
#pragma GCC diagnostic pop

void show(uint8_t const * data, size_t len) {
	Tlv_t tlv;
	TlvTraverseTags(data, len, printTlvInfo, NULL, true, &tlv, 0);
}

void findTag (const uint8_t* buffer, size_t length, uint16_t tag) {
	Tlv_t tlv;
	if(TlvSearchTag(buffer, length, tag, true, &tlv)) {
		printf("\nFound:");
		printtag(tlv.tag, 0);
		printf("\n");
	} else
		printf("\n!!!Failed to find tag %hi\n\n", tag);
}

BOOL decodeTxnInfo(Tlv_t* tlv, void * ctx, int level) {
	TxnInfo_t * txnInfo = (TxnInfo_t*)ctx;
	if (level != 1) return false;
	uint16_t tagValue = tagNumber(tlv->tag);
	switch (tagValue) {
		case 1:
			strcpy(txnInfo->TxnRef, (char*)tlv->val);
			break;
		case 2:
			memcpy(&txnInfo->amount, tlv->val, sizeof txnInfo->amount);
			break;
		case 3:
			memcpy(&txnInfo->txnType, tlv->val, sizeof txnInfo->txnType);
			break;
		case 4:
			memcpy(&txnInfo->currencyCode, tlv->val, sizeof txnInfo->currencyCode);
			break;
	}
	return false;
}

uint16_t tagFromParts(uint8_t tagNum, uint8_t class, BOOL constructed) {
	uint16_t tag = class << 6;
	tag |= (constructed ? 1 : 0) << 5;
	if (tagNum >= 0x1f) {
		tag |= 0x1f;
		tag <<= 8;
	}
	tag |= tagNum;
	return tag;
}

int main () {
	uint8_t tlv1Data[] =
	{
		0x70,0x43,0x5F,0x20,0x1A,0x56,0x49,0x53,
		0x42,0x20,0x41,0x43,0x51,0x55,0x49,0x52,
		0x45,0x52,0x20,0x54,0x45,0x53,0x54,0x20,
		0x43,0x41,0x52,0x44,0x20,0x32,0x39,0x57,
		0x11,0x47,0x61,0x73,0x90,0x01,0x01,0x00,
		0x10,0xD1,0x01,0x22,0x01,0x11,0x43,0x87,
		0x80,0x89,0x9F,0x1F,0x10,0x31,0x31,0x34,
		0x33,0x38,0x30,0x30,0x37,0x38,0x30,0x30,
		0x30,0x30,0x30,0x30,0x30,0x90,0x00
	};
	uint8_t tlv2Data[] =
	{
		0x00, 0x00,
		0x70,0x81,0x83,0x90,0x81,0x80,0x6F,0xC4,
		0x63,0xDD,0xD0,0x2A,0x73,0xB3,0x5C,0x84,
		0xDA,0xA7,0x26,0xEE,0x4D,0x3F,0x25,0x32,
		0x66,0x22,0xF1,0xD8,0x2A,0x07,0x48,0x11,
		0xAE,0x2B,0x1B,0x9A,0x67,0xCB,0x58,0xD9,
		0x55,0x73,0x5E,0xE6,0x35,0xD5,0x71,0xF3,
		0x9B,0x5C,0xE0,0xF6,0x4D,0x71,0xAF,0x73,
		0x2D,0x83,0xF3,0x7E,0x2B,0xD5,0x6D,0x67,
		0x22,0x13,0x76,0xC9,0x9B,0x14,0x3B,0x05,
		0x30,0xF2,0xFC,0xEA,0xB2,0xFE,0x63,0x50,
		0xC6,0x2F,0xCE,0xA0,0xC1,0x63,0xE4,0xBD,
		0x84,0xEC,0xB8,0x43,0x42,0xD0,0x5E,0xBF,
		0xB6,0x8F,0x6A,0x9E,0x49,0x96,0xD2,0xCA,
		0xB9,0x63,0x96,0x2E,0x54,0x8A,0x5B,0xEE,
		0xF5,0xEF,0xFF,0xD0,0x19,0x55,0xB9,0x2A,
		0xB5,0x06,0x4B,0xAC,0xB0,0xC8,0xBC,0x3E,
		0x1C,0x40,0x28,0x6D,0xFE,0xFC
	};
	uint8_t tlv3Data[] =
	{
		0x00,0x00,
		0x70,0x0E,0x5A,0x08,0x47,0x61,0x73,0x90,
		0x01,0x01,0x00,0x10,0x5F,0x34,0x01,0x01,
		0x90,0x00
	};
	uint8_t tlv4Data[] =
	{

		0x70,0x59,0x60,0x14,0x57,0x12,0x47,0x61,
		0x73,0x90,0x01,0x01,0x00,0x10,0xD1,0x01,
		0x22,0x01,0x11,0x43,0x87,0x80,0x89,0x90,
		0x5F,0x20,0x1A,0x56,0x49,0x53,0x41,0x20,
		0x41,0x43,0x51,0x55,0x49,0x52,0x45,0x52,
		0x20,0x54,0x45,0x53,0x54,0x20,0x43,0x41,
		0x52,0x44,0x20,0x32,0x39,0x57,0x11,0x47,
		0x61,0x73,0x90,0x01,0x01,0x00,0x10,0xD1,
		0x01,0x22,0x01,0x11,0x43,0x87,0x80,0x89,
		0x9F,0x1F,0x10,0x31,0x31,0x34,0x33,0x38,
		0x30,0x30,0x37,0x38,0x30,0x30,0x30,0x30,
		0x30,0x30,0x30,0x90,0x00
	};

	printf("tlv1Data\n");
	show(tlv1Data, sizeof(tlv1Data));

	printf("\n\n\ntlv2Data\n");
	show(tlv2Data, sizeof(tlv2Data));

	printf("\n\n\ntlv3Data\n");
	show(tlv3Data, sizeof(tlv3Data));

	printf("\n\n\ntlv4Data\n");
	show(tlv4Data, sizeof(tlv4Data));

	printf("\n\n");
	findTag(tlv1Data, sizeof tlv1Data, tagFromParts(23,1,0));
	findTag(tlv3Data, sizeof tlv3Data, tagFromParts(52,1,0));
	findTag(tlv4Data, sizeof tlv4Data, tagFromParts(23,1,0));

	TxnInfo_t txnInfo = {
		.TxnRef = "Hello",
		.amount = 0xf012e739,
		.txnType = 0xbf,
		.currencyCode = 0xcf43
	};

	uint8_t bigBuf[32] = {0};

	Tlv_t tlv;
	assert(TlvCreate(&tlv,tagFromParts(0, 1, 1), bigBuf, (sizeof bigBuf)));
	assert(TlvAddData(&tlv, tagFromParts(4, 3, 0), (uint8_t *)&txnInfo.currencyCode, sizeof txnInfo.currencyCode));
	assert(TlvAddData(&tlv, tagFromParts(3, 3, 0), (uint8_t *)&txnInfo.txnType, sizeof txnInfo.txnType));
	assert(TlvAddData(&tlv, tagFromParts(2, 3, 0), (uint8_t *)&txnInfo.amount, sizeof txnInfo.amount));
	assert(TlvAddData(&tlv, tagFromParts(1, 3, 0), (uint8_t *)txnInfo.TxnRef, sizeof txnInfo.TxnRef));

	printf("\n\nTxnInfo_t encoding\n");
	show(bigBuf, sizeof bigBuf);

	TxnInfo_t txnInfoOut;
	TlvTraverseTags(bigBuf, sizeof bigBuf, decodeTxnInfo, &txnInfoOut, true, &tlv, 0);
	assert(strcmp(txnInfoOut.TxnRef, txnInfo.TxnRef) == 0);
	assert(txnInfoOut.amount == txnInfo.amount);
	assert(txnInfoOut.txnType == txnInfo.txnType);
	assert(txnInfoOut.currencyCode == txnInfo.currencyCode);
}
